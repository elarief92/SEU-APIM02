resources:
  - repo: self

variables:
- group: APIM-VARS
- name: timestamp
  value: $[format('{0:yyyyMMddHHmmss}', pipeline.startTime)]
- name: buildTimestamp
  value: $[format('{0:yyyyMMdd-HHmmss}', pipeline.startTime)]

stages:
  - stage: Build
    displayName: Build Container Image
    jobs:
      - job: Build
        displayName: Build and Push to ACR
        pool:
          vmImage: 'ubuntu-latest'
        steps:
        - checkout: self  # Checkout source code
        
        - task: Docker@2
          displayName: Build and Push Docker Image
          inputs:
            containerRegistry: '$(ACR_SERVICE_CONNECTION)'
            repository: '$(IMAGE_REPOSITORY)'
            command: 'buildAndPush'
            Dockerfile: '$(DOCKERFILE_PATH)'
            tags: |
              $(timestamp)
              $(buildTimestamp)
              latest

        - task: Bash@3
          displayName: List Docker Images
          inputs:
            targetType: 'inline'
            script: |
              echo "=== Listing all Docker images on agent ==="
              docker image ls
              
        - task: Bash@3
          displayName: Verify ACR Push
          inputs:
            targetType: 'inline'
            script: |
                  echo "=== Build Verification ==="
                  echo "Image successfully built and pushed to ACR"
                  echo "Image: $(ACR_SERVICE_CONNECTION)/$(IMAGE_REPOSITORY):$(Build.BuildId)"
                  echo ""
                  echo "=== Local Docker images containing repository name ==="
                  docker images | grep "$(IMAGE_REPOSITORY)"