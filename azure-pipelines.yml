resources:
  - repo: self

variables:
- group: APIM-VARS

stages:
  - stage: Build
    displayName: Build Container Image
    jobs:
      - job: Build
        displayName: Build and Push to ACR
        pool:
          vmImage: 'ubuntu-latest'
        steps:
        - checkout: self
          fetchDepth: 1
        
        - task: Bash@3
          displayName: Generate Tags
          inputs:
            targetType: 'inline'
            script: |
              TIMESTAMP=$(date +%Y%m%d-%H%M%S)
              SHORT_COMMIT=$(git rev-parse --short HEAD)
              echo "##vso[task.setvariable variable=timestamp]${TIMESTAMP}"
              echo "##vso[task.setvariable variable=shortCommitId]${SHORT_COMMIT}"
              echo "Generated timestamp: ${TIMESTAMP}"
              echo "Generated commit ID: ${SHORT_COMMIT}"
        
        - task: Docker@2
          displayName: Build and Push Docker Image
          inputs:
            containerRegistry: '$(ACR_SERVICE_CONNECTION)'
            repository: '$(IMAGE_REPOSITORY)'
            command: 'buildAndPush'
            Dockerfile: '$(DOCKERFILE_PATH)'
            tags: |
              latest
              $(timestamp)-comID-$(shortCommitId)

        - task: Bash@3
          displayName: Verify Build
          inputs:
            targetType: 'inline'
            script: |
              echo "=== Build Verification ==="
              echo "Image: $(IMAGE_REPOSITORY)"
              echo "Tags:"
              echo "  - latest"
              echo "  - $(timestamp)-comID-$(shortCommitId)"
              echo ""
              echo "=== Docker Images ==="
              docker images | grep "$(IMAGE_REPOSITORY)"