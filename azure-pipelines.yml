resources:
  - repo: self

variables:
- group: APIM-VARS

stages:
  - stage: Build
    displayName: Build Container Image
    jobs:
      - job: Build
        displayName: Build and Push to ACR
        pool:
          vmImage: 'ubuntu-latest'
        steps:
        - checkout: self
          fetchDepth: 1
        
        - task: Bash@3
          displayName: Generate Tags
          inputs:
            targetType: 'inline'
            script: |
              TIMESTAMP=$(date +%Y%m%d-%H%M%S)
              SHORT_COMMIT=$(git rev-parse --short HEAD)
              echo "##vso[task.setvariable variable=timestamp]${TIMESTAMP}"
              echo "##vso[task.setvariable variable=shortCommitId]${SHORT_COMMIT}"
              echo "Generated timestamp: ${TIMESTAMP}"
              echo "Generated commit ID: ${SHORT_COMMIT}"
        
        - task: Docker@2
          displayName: Build and Push Docker Image
          inputs:
            containerRegistry: '$(ACR_SERVICE_CONNECTION)'
            repository: '$(IMAGE_REPOSITORY)'
            command: 'buildAndPush'
            Dockerfile: '$(DOCKERFILE_PATH)'
            tags: |
              latest
              $(timestamp)-comID-$(shortCommitId)

        - task: Bash@3
          displayName: Verify Build
          inputs:
            targetType: 'inline'
            script: |
              echo "=== Build Verification ==="
              echo "Image: $(IMAGE_REPOSITORY)"
              echo "Tags:"
              echo "  - latest"
              echo "  - $(timestamp)-comID-$(shortCommitId)"
              echo ""
              echo "=== Docker Images ==="
              docker images | grep "$(IMAGE_REPOSITORY)"

        # NEW TASKS FOR KUBERNETES MANIFESTS
        - task: Bash@3
          displayName: List Kubernetes Files
          inputs:
            targetType: 'inline'
            script: |
              echo "=== Kubernetes Directory Structure ==="
              find ./kubernetes -name "*.yaml" -o -name "*.yml" | sort
              echo ""
              echo "=== File Details ==="
              ls -la ./kubernetes/

        - task: CopyFiles@2
          displayName: 'Copy Kubernetes Manifests to Staging'
          inputs:
            SourceFolder: 'kubernetes'
            Contents: '**/*.yaml'
            TargetFolder: '$(Build.ArtifactStagingDirectory)/kube-manifests'
            OverWrite: true

        - task: Bash@3
          displayName: Verify Copied Manifests
          inputs:
            targetType: 'inline'
            script: |
              echo "=== Files in Artifact Staging Directory ==="
              find $(Build.ArtifactStagingDirectory) -name "*.yaml" | sort
              echo ""
              echo "=== kube-manifests directory contents ==="
              ls -la $(Build.ArtifactStagingDirectory)/kube-manifests/

        - task: PublishBuildArtifacts@1
          displayName: 'Publish Kubernetes Manifests'
          inputs:
            PathtoPublish: '$(Build.ArtifactStagingDirectory)/kube-manifests'
            ArtifactName: 'kube-manifests'
            publishLocation: 'Container'

        # Optional: Also publish as Pipeline Artifact for backup
        - task: PublishPipelineArtifact@1
          displayName: 'Publish Pipeline Artifact'
          inputs:
            targetPath: '$(Build.ArtifactStagingDirectory)/kube-manifests'
            artifact: 'manifests'
            publishLocation: 'pipeline'