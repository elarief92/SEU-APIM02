resources:
  - repo: self

variables:
- group: APIM-VARS

stages:
  - stage: Build
    displayName: Build Container Image
    jobs:
      - job: Build
        displayName: Build and Push to ACR
        pool:
          vmImage: 'ubuntu-latest'
        steps:
        - checkout: self
          fetchDepth: 1
        
        - task: Bash@3
          displayName: Generate Tags
          inputs:
            targetType: 'inline'
            script: |
              TIMESTAMP=$(date +%Y%m%d-%H%M%S)
              SHORT_COMMIT=$(git rev-parse --short HEAD)
              echo "##vso[task.setvariable variable=timestamp]${TIMESTAMP}"
              echo "##vso[task.setvariable variable=shortCommitId]${SHORT_COMMIT}"
              echo "Generated timestamp: ${TIMESTAMP}"
              echo "Generated commit ID: ${SHORT_COMMIT}"
        
        - task: Docker@2
          displayName: Build and Push Docker Image
          inputs:
            containerRegistry: '$(ACR_SERVICE_CONNECTION)'
            repository: '$(IMAGE_REPOSITORY)'
            command: 'buildAndPush'
            Dockerfile: '$(DOCKERFILE_PATH)'
            tags: |
              latest
              $(timestamp)-comID-$(shortCommitId)

        - task: Bash@3
          displayName: Verify Build
          inputs:
            targetType: 'inline'
            script: |
              echo "=== Build Verification ==="
              echo "Image: $(IMAGE_REPOSITORY)"
              echo "Tags:"
              echo "  - latest"
              echo "  - $(timestamp)-comID-$(shortCommitId)"

        # SEPARATE PRODUCTION AND STAGING MANIFESTS
        - task: CopyFiles@2
          displayName: 'Copy Production Manifests to Staging'
          inputs:
            SourceFolder: 'kubernetes/Production'
            Contents: 'production-*.yaml'
            TargetFolder: '$(Build.ArtifactStagingDirectory)/production-manifests'
            OverWrite: true

        - task: CopyFiles@2
          displayName: 'Copy Staging Manifests to Staging'
          inputs:
            SourceFolder: 'kubernetes/Staging'
            Contents: 'staging-*.yaml'
            TargetFolder: '$(Build.ArtifactStagingDirectory)/staging-manifests'
            OverWrite: true

        - task: Bash@3
          displayName: Verify Separated Manifests
          inputs:
            targetType: 'inline'
            script: |
              echo "=== Production Manifests ==="
              find $(Build.ArtifactStagingDirectory)/production-manifests -name "*.yaml" | sort
              echo ""
              echo "=== Staging Manifests ==="
              find $(Build.ArtifactStagingDirectory)/staging-manifests -name "*.yaml" | sort
              echo ""
              echo "=== File Counts ==="
              echo "Production: $(find $(Build.ArtifactStagingDirectory)/production-manifests -name "*.yaml" | wc -l) files"
              echo "Staging: $(find $(Build.ArtifactStagingDirectory)/staging-manifests -name "*.yaml" | wc -l) files"

        # PUBLISH PIPELINE ARTIFACTS  
        - task: PublishPipelineArtifact@1
          displayName: 'Publish Production Pipeline Artifact'
          inputs:
            targetPath: '$(Build.ArtifactStagingDirectory)/production-manifests'
            artifact: 'production-manifests'
            publishLocation: 'pipeline'

        - task: PublishPipelineArtifact@1
          displayName: 'Publish Staging Pipeline Artifact'
          inputs:
            targetPath: '$(Build.ArtifactStagingDirectory)/staging-manifests'
            artifact: 'staging-manifests'
            publishLocation: 'pipeline'