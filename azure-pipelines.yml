resources:
  - repo: self

variables:
- group: APIM-VARS

stages:
  - stage: Build
    displayName: Build Container Image
    jobs:
      - job: Build
        displayName: Build and Push to ACR
        pool:
          vmImage: 'ubuntu-latest'
        steps:
        - checkout: self  # Checkout source code
        
        - task: Docker@2
          displayName: Build and Push Docker Image
          inputs:
            containerRegistry: '$(ACR_SERVICE_CONNECTION)'
            repository: '$(IMAGE_REPOSITORY)'
            command: 'buildAndPush'
            Dockerfile: '$(DOCKERFILE_PATH)'
            tags: |
              $(Build.BuildId)
              latest

        - task: Bash@3
          displayName: List Docker Images
          inputs:
            targetType: 'inline'
            script: |
              echo "=== Listing all Docker images on agent ==="
              docker image ls
              
        - task: Bash@3
          displayName: List ACR Repository Images
          inputs:
            targetType: 'inline'
            script: |
              echo "=== Logging into ACR ==="
              docker login $(ACR_NAME).azurecr.io --username $(ACR_USERNAME) --password $(ACR_PASSWORD)
              echo ""
              echo "=== Pulling image manifest ==="
              docker pull $(ACR_NAME).azurecr.io/$(IMAGE_REPOSITORY):$(Build.BuildId)
              echo ""
              echo "=== Verifying image in local cache ==="
              docker images | grep $(ACR_NAME)